@page "/login"
@layout MainLayout
@using System.ComponentModel.DataAnnotations
@using PersonalFinance.Web.Models 
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<div class="form-container">
    <div class="form-card">
        <h1 class="form-title">Вход в систему</h1>
        <p class="form-subtitle">Войдите в свой аккаунт</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                @errorMessage
            </div>
        }

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label">Email</label>
                <div class="input-with-icon">
                    <span class="input-icon">📧</span>
                    <InputText @bind-Value="loginModel.Email"
                               class="form-input"
                               placeholder="example@email.com" />
                </div>
                <ValidationMessage For="@(() => loginModel.Email)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">Пароль</label>
                <div class="input-with-icon">
                    <span class="input-icon">🔒</span>
                    <InputText type="password"
                               @bind-Value="loginModel.Password"
                               class="form-input"
                               placeholder="Введите пароль" />
                </div>
                <ValidationMessage For="@(() => loginModel.Password)" class="validation-message" />
            </div>

            <button type="submit" class="form-button" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Вход...</span>
                }
                else
                {
                    <span>Войти</span>
                }
            </button>
        </EditForm>

        <div class="form-footer">
            Нет аккаунта?
            <a href="/register" class="form-link">Зарегистрироваться</a>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            Console.WriteLine($"Попытка входа: {loginModel.Email}");

            var result = await AuthService.LoginAsync(loginModel);

            if (result.Success)
            {
                Console.WriteLine("✅ Успешный вход! Перенаправляем на дашборд...");
                NavigationManager.NavigateTo("/transactions", forceLoad: true);
            }
            else
            {
                errorMessage = result.Message ?? "Неверный email или пароль";
                Console.WriteLine($"❌ Ошибка входа: {errorMessage}");
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Ошибка соединения: {ex.Message}";
            Console.WriteLine($"❌ HTTP ошибка: {ex.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}";
            Console.WriteLine($"❌ Исключение: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    }