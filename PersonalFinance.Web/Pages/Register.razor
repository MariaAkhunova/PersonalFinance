@page "/register"
@layout MainLayout
@using System.ComponentModel.DataAnnotations
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@using PersonalFinance.Web.Models

<div class="form-container">
    <div class="form-card">
        <h1 class="form-title">Регистрация</h1>
        <p class="form-subtitle">Создайте аккаунт для управления финансами</p>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                @successMessage
            </div>
        }

        <EditForm Model="@registerModel" OnValidSubmit="@HandleRegister">
            <DataAnnotationsValidator />

            <div class="form-group">
                <label class="form-label">Имя</label>
                <div class="input-with-icon">
                    <span class="input-icon">👤</span>
                    <InputText @bind-Value="registerModel.FirstName"
                               class="form-input"
                               placeholder="Введите имя" />
                </div>
                <ValidationMessage For="@(() => registerModel.FirstName)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">Фамилия</label>
                <div class="input-with-icon">
                    <span class="input-icon">👤</span>
                    <InputText @bind-Value="registerModel.LastName"
                               class="form-input"
                               placeholder="Введите фамилию" />
                </div>
                <ValidationMessage For="@(() => registerModel.LastName)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <div class="input-with-icon">
                    <span class="input-icon">📧</span>
                    <InputText @bind-Value="registerModel.Email"
                               class="form-input"
                               placeholder="example@email.com" />
                </div>
                <ValidationMessage For="@(() => registerModel.Email)" class="validation-message" />
            </div>

            <div class="form-group">
                <label class="form-label">Пароль</label>
                <div class="input-with-icon">
                    <span class="input-icon">🔒</span>
                    <InputText type="password"
                               @bind-Value="registerModel.Password"
                               class="form-input"
                               placeholder="Минимум 6 символов" />
                </div>
                <ValidationMessage For="@(() => registerModel.Password)" class="validation-message" />
            </div>

            <button type="submit" class="form-button" disabled="@isLoading">
                @if (isLoading)
                {
                    <span>Регистрация...</span>
                }
                else
                {
                    <span>Зарегистрироваться</span>
                }
            </button>
        </EditForm>

        <div class="form-footer">
            Уже есть аккаунт?
            <a href="/login" class="form-link">Войти</a>
        </div>
    </div>
</div>

@code {
  private RegisterModel registerModel = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        errorMessage = null;
        successMessage = null;
        isLoading = true;

        try
        {
            Console.WriteLine($"Попытка регистрации: {registerModel.Email}");

            var result = await AuthService.RegisterAsync(registerModel);

            if (result.Success)
            {
                successMessage = result.Message ?? "✅ Регистрация успешна!";
                Console.WriteLine("✅ Успешная регистрация!");

                await Task.Delay(2000);
                NavigationManager.NavigateTo("/login");
            }
            else
            {
                errorMessage = result.Message ?? "Ошибка регистрации";
                Console.WriteLine($"❌ Ошибка регистрации: {errorMessage}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Произошла ошибка: {ex.Message}";
            Console.WriteLine($"❌ Исключение: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}