@page "/transactions"
@attribute [Authorize]
@layout MainLayout
@inject AuthService AuthService
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="page-container">
    <!-- Заголовок и кнопка с отступом -->
    <div class="page-header">
        <h1>Транзакции</h1>
        <button @onclick="ShowAddModal"
                class="transaction-btn btn-new-transaction">
            <i class="fas fa-plus-circle"></i> Новая транзакция
        </button>
    </div>

    <!-- Статистика -->
    <div class="stats-row">
        <div class="stat-card total-income">
            <div class="stat-icon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@totalIncome.ToString("C")</div>
                <div class="stat-label">Общий доход</div>
            </div>
        </div>

        <div class="stat-card total-expense">
            <div class="stat-icon">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@totalExpense.ToString("C")</div>
                <div class="stat-label">Общие расходы</div>
            </div>
        </div>

        <div class="stat-card balance">
            <div class="stat-icon">
                <i class="fas fa-balance-scale"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@balance.ToString("C")</div>
                <div class="stat-label">Баланс</div>
            </div>
        </div>
    </div>

    <!-- Таблица транзакций -->
    <div class="transactions-table-container">
        <div class="table-header">
            <h2><i class="fas fa-history"></i> История транзакций</h2>
            <div class="filter-buttons">
                <button class="filter-btn all @(filter == "all" ? "active" : "")"
                        @onclick="SetFilterAll">
                    Все
                </button>
                <button class="filter-btn income @(filter == "income" ? "active" : "")"
                        @onclick="SetFilterIncome">
                    Доходы
                </button>
                <button class="filter-btn expense @(filter == "expense" ? "active" : "")"
                        @onclick="SetFilterExpense">
                    Расходы
                </button>
            </div>
        </div>

        @if (transactions.Count == 0)
        {
            <div class="empty-state">
                <i class="fas fa-receipt"></i>
                <h3>Транзакций пока нет</h3>
                <p>Начните отслеживать свои финансы, добавив первую транзакцию!</p>
                <button @onclick="ShowAddModal" class="transaction-btn btn-new-transaction">
                    <i class="fas fa-plus me-2"></i> Добавить транзакцию
                </button>
            </div>
        }
        else
        {
            <div class="table-wrapper">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Категория</th>
                            <th>Описание</th>
                            <th class="text-end">Сумма</th>
                            <th class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var trans in filteredTransactions)
                        {
                            <tr>
                                <td nowrap>@trans.Date.ToString("dd.MM.yyyy")</td>
                                <td>
                                    @if (trans.Category != null)
                                    {
                                        <span class="category-badge @(trans.Category.IsIncome ? "income" : "expense")">
                                            @trans.Category.Name
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Без категории</span>
                                    }
                                </td>
                                <td>@(trans.Description ?? "-")</td>
                                <td class="text-end @(trans.Category?.IsIncome == true ? "text-success fw-bold" : "text-danger fw-bold")">
                                    @if (trans.Category?.IsIncome == true)
                                    {
                                        <i class="fas fa-arrow-up me-1"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-arrow-down me-1"></i>
                                    }
                                    @trans.Amount.ToString("C")
                                </td>
                                <td class="text-center">
                                    <div class="action-buttons">
                                        <button @onclick="() => EditTransaction(trans)"
                                                class="action-btn edit"
                                                title="Редактировать">
                                            <i class="fas fa-edit me-1"></i>
                                            <span class="action-text">Изменить</span>
                                        </button>
                                        <button @onclick="() => DeleteTransaction(trans)"
                                                class="action-btn delete"
                                                title="Удалить">
                                            <i class="fas fa-trash me-1"></i>
                                            <span class="action-text">Удалить</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Модальное окно добавления/редактирования транзакции -->
@if (showModal)
{
    <div class="modal-backdrop"></div>
    <div class="modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(editingTransaction == null ? "Новая транзакция" : "Редактирование транзакции")
                    </h5>
                    <button type="button" class="modal-close" @onclick="CloseModal">&times;</button>
                </div>

                <div class="modal-body">
                    <!-- Форма для транзакции -->
                    <div class="form-group">
                        <label class="form-label">Тип *</label>
                        <div class="type-buttons">
                            <button type="button"
                                    class="type-btn income @(isIncome ? "active" : "")"
                                    @onclick="SetIncomeType">
                                <i class="fas fa-arrow-up"></i> Доход
                            </button>
                            <button type="button"
                                    class="type-btn expense @(!isIncome ? "active" : "")"
                                    @onclick="SetExpenseType">
                                <i class="fas fa-arrow-down"></i> Расход
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Категория *</label>
                        <select @bind="transaction.CategoryId" class="form-select" required>
                            <option value="0">Выберите категорию</option>
                            @if (categories != null)
                            {
                                @foreach (var category in categories.Where(c => c.IsIncome == isIncome))
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            }
                        </select>
                        @if (!string.IsNullOrEmpty(categoryValidationMessage))
                        {
                            <div class="text-danger mt-2 small">
                                @categoryValidationMessage
                            </div>
                        }
                    </div>

                    <div class="form-group">
                        <label class="form-label">Сумма *</label>
                        <input type="number" step="0.01" min="0.01"
                               @bind="transaction.Amount"
                               @bind:event="oninput"
                               class="form-control"
                               placeholder="0.00"
                               required />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Дата *</label>
                        <input type="date"
                               @bind="transaction.Date"
                               @bind:format="yyyy-MM-dd"
                               class="form-control"
                               required />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Описание</label>
                        <textarea @bind="transaction.Description"
                                  @bind:event="oninput"
                                  class="form-control"
                                  rows="3"
                                  placeholder="Описание транзакции..."></textarea>
                    </div>

                    <!-- Кнопки модального окна -->
                    <div class="modal-buttons">
                        <button type="button"
                                class="transaction-btn btn-cancel"
                                @onclick="CloseModal">
                            <i class="fas fa-times"></i> Отмена
                        </button>
                        <button type="button"
                                class="transaction-btn btn-save"
                                disabled="@isSaving"
                                @onclick="SaveTransaction">
                            <i class="fas fa-save"></i>
                            @if (isSaving)
                            {
                                <span>Сохранение...</span>
                            }
                            else
                            {
                                <span>Сохранить</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Transaction> transactions = new();
    private List<Category> categories = new();
    private List<Transaction> filteredTransactions = new();
    private TransactionCreateModel transaction = new();
    private Transaction? editingTransaction;

    private decimal totalIncome = 0;
    private decimal totalExpense = 0;
    private decimal balance = 0;

    private bool showModal = false;
    private bool isSaving = false;
    private bool isIncome = true;
    private string filter = "all";
    private string categoryValidationMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            Console.WriteLine("Начало загрузки данных...");

            // Загружаем транзакции
            var transResult = await TransactionService.GetTransactionsAsync();
            transactions = transResult ?? new List<Transaction>();
            Console.WriteLine($"Загружено транзакций: {transactions.Count}");

            // Загружаем категории
            var catResult = await CategoryService.GetCategoriesAsync();
            categories = catResult ?? new List<Category>();
            Console.WriteLine($"Загружено категорий: {categories.Count}");

            // 🔥 ВАЖНО: Вызываем метод связывания
            LinkCategoriesToTransactions();

            // Рассчитываем статистику
            CalculateStatistics();

            // Применяем фильтр
            ApplyFilter();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки данных: {ex.Message}");
        }
    }

    private void LinkCategoriesToTransactions()
    {
        Console.WriteLine("=== LinkCategoriesToTransactions() called ===");

        if (!transactions.Any() || !categories.Any())
        {
            Console.WriteLine("Нечего связывать: нет транзакций или категорий");
            return;
        }

        Console.WriteLine($"Будем связывать {transactions.Count} транзакций с {categories.Count} категориями");

        // Создаем словарь категорий для быстрого поиска
        var categoryDict = categories.ToDictionary(c => c.Id, c => c);

        int linkedCount = 0;

        foreach (var transaction in transactions)
        {
            Console.WriteLine($"Обрабатываем транзакцию ID: {transaction.Id}, CategoryId: {transaction.CategoryId}");

            if (transaction.CategoryId > 0 && categoryDict.TryGetValue(transaction.CategoryId, out var category))
            {
                transaction.Category = category;
                linkedCount++;
                Console.WriteLine($"  ✓ Связано с категорией: {category.Name} (ID: {category.Id})");
            }
            else if (transaction.CategoryId > 0)
            {
                Console.WriteLine($"  ✗ Категория ID {transaction.CategoryId} не найдена!");
            }
            else
            {
                Console.WriteLine($"  ⚠️ CategoryId = 0 или отрицательный");
            }
        }

        Console.WriteLine($"Итого связано: {linkedCount}/{transactions.Count} транзакций");
    }

    private void CalculateStatistics()
    {
        totalIncome = 0;
        totalExpense = 0;

        if (transactions != null && transactions.Any())
        {
            Console.WriteLine("=== CalculateStatistics() ===");

            // Вариант 1: Используем уже связанные категории
            var incomeTransactions = transactions
                .Where(t => t.Category != null && t.Category.IsIncome == true)
                .ToList();

            var expenseTransactions = transactions
                .Where(t => t.Category != null && t.Category.IsIncome == false)
                .ToList();

            totalIncome = incomeTransactions.Sum(t => t.Amount);
            totalExpense = expenseTransactions.Sum(t => t.Amount);

            Console.WriteLine($"Доходные транзакции (через Category): {incomeTransactions.Count}, Сумма: {totalIncome}");
            Console.WriteLine($"Расходные транзакции (через Category): {expenseTransactions.Count}, Сумма: {totalExpense}");

            // Если через Category не сработало, пробуем через словарь
            if (totalIncome == 0 && totalExpense == 0 && categories.Any())
            {
                Console.WriteLine("Пробуем расчет через словарь категорий...");

                var categoryDict = categories.ToDictionary(c => c.Id, c => c.IsIncome);

                foreach (var t in transactions)
                {
                    if (categoryDict.TryGetValue(t.CategoryId, out var isIncomeCategory))
                    {
                        if (isIncomeCategory == true)
                            totalIncome += t.Amount;
                        else
                            totalExpense += t.Amount;
                    }
                    else
                    {
                        Console.WriteLine($"  Транзакция {t.Id}: Категория {t.CategoryId} не найдена в словаре!");
                    }
                }
            }
        }

        balance = totalIncome - totalExpense;
        Console.WriteLine($"Итог: Доходы = {totalIncome}, Расходы = {totalExpense}, Баланс = {balance}");
    }

    private void ApplyFilter()
    {
        if (transactions == null)
        {
            filteredTransactions = new List<Transaction>();
            return;
        }

        Console.WriteLine($"=== ApplyFilter('{filter}') ===");

        // Создаем словарь категорий для фильтрации
        var categoryDict = categories.ToDictionary(c => c.Id, c => c.IsIncome);

        filteredTransactions = filter switch
        {
            "income" => transactions
                .Where(t =>
                {
                    if (t.Category != null)
                    {
                        return t.Category.IsIncome == true;
                    }
                    else if (categoryDict.TryGetValue(t.CategoryId, out var isIncome))
                    {
                        return isIncome == true;
                    }
                    return false;
                })
                .ToList(),
            "expense" => transactions
                .Where(t =>
                {
                    if (t.Category != null)
                    {
                        return t.Category.IsIncome == false;
                    }
                    else if (categoryDict.TryGetValue(t.CategoryId, out var isIncome))
                    {
                        return isIncome == false;
                    }
                    return false;
                })
                .ToList(),
            _ => transactions
        };

        Console.WriteLine($"Найдено транзакций: {filteredTransactions.Count}");
    }

    private void SetFilter(string newFilter)
    {
        filter = newFilter;
        ApplyFilter();
        StateHasChanged();
    }

    private void SetFilterAll() => SetFilter("all");
    private void SetFilterIncome() => SetFilter("income");
    private void SetFilterExpense() => SetFilter("expense");

    private void SetIncomeType()
    {
        isIncome = true;
        transaction.CategoryId = 0;
        categoryValidationMessage = string.Empty;
        StateHasChanged();
    }

    private void SetExpenseType()
    {
        isIncome = false;
        transaction.CategoryId = 0;
        categoryValidationMessage = string.Empty;
        StateHasChanged();
    }

    private void ShowAddModal()
    {
        transaction = new TransactionCreateModel
        {
            Date = DateTime.Now,
            Amount = 0,
            CategoryId = 0
        };
        editingTransaction = null;
        isIncome = true;
        categoryValidationMessage = string.Empty;
        showModal = true;
        StateHasChanged();
    }

    private void EditTransaction(Transaction t)
    {
        editingTransaction = t;
        transaction = new TransactionCreateModel
        {
            Amount = t.Amount,
            Description = t.Description,
            Date = t.Date,
            CategoryId = t.CategoryId
        };
        isIncome = t.Category?.IsIncome == true;
        categoryValidationMessage = string.Empty;
        showModal = true;
        StateHasChanged();
    }

    private async Task SaveTransaction()
    {
        // Валидация
        categoryValidationMessage = string.Empty;

        if (transaction.CategoryId == 0)
        {
            categoryValidationMessage = "Пожалуйста, выберите категорию";
            StateHasChanged();
            return;
        }

        if (transaction.Amount <= 0)
        {
            categoryValidationMessage = "Сумма должна быть больше 0";
            StateHasChanged();
            return;
        }

        if (transaction.Date == default)
        {
            transaction.Date = DateTime.Now;
        }

        isSaving = true;
        StateHasChanged();

        try
        {
            bool success = false;

            if (editingTransaction != null)
            {
                // Редактирование существующей транзакции
                var updateTransaction = new Transaction
                {
                    Id = editingTransaction.Id,
                    Amount = transaction.Amount,
                    Description = transaction.Description,
                    Date = transaction.Date,
                    CategoryId = transaction.CategoryId
                };

                success = await TransactionService.UpdateTransactionAsync(editingTransaction.Id, updateTransaction);
            }
            else
            {
                // Создание новой транзакции
                success = await TransactionService.CreateTransactionAsync(transaction);
            }

            if (success)
            {
                await LoadData();
                CloseModal();
            }
            else
            {
                categoryValidationMessage = "Не удалось сохранить транзакцию";
                Console.WriteLine("Не удалось сохранить транзакцию");
            }
        }
        catch (Exception ex)
        {
            categoryValidationMessage = $"Ошибка сохранения: {ex.Message}";
            Console.WriteLine($"Ошибка сохранения: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task DeleteTransaction(Transaction t)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Удалить эту транзакцию?");

        if (confirmed)
        {
            try
            {
                var success = await TransactionService.DeleteTransactionAsync(t.Id);
                if (success)
                {
                    await LoadData();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка удаления: {ex.Message}");
            }
        }
    }

    private void CloseModal()
    {
        showModal = false;
        transaction = new TransactionCreateModel();
        categoryValidationMessage = string.Empty;
        StateHasChanged();
    }
    private async Task LoadTransactionsWithCategories()
    {
        // Загружаем транзакции
        var transactionsData = await TransactionService.GetTransactionsAsync();

        // Загружаем категории
        var categoriesData = await CategoryService.GetCategoriesAsync();

        // Создаем словарь категорий
        var categoryDict = categoriesData.ToDictionary(c => c.Id, c => c);

        // Присваиваем категории каждой транзакции
        foreach (var transaction in transactionsData)
        {
            if (transaction.CategoryId > 0 && categoryDict.ContainsKey(transaction.CategoryId))
            {
                transaction.Category = categoryDict[transaction.CategoryId];
            }
        }

        transactions = transactionsData;
        categories = categoriesData;
    }
}