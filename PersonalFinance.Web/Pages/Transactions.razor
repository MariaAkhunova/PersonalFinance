@page "/transactions"
@attribute [Authorize]
@layout MainLayout
@inject AuthService AuthService
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<div class="transactions-page">
    <div class="page-header">
        <h1>💰 Мои транзакции</h1>
        <div class="header-actions">
            <button @onclick="ShowAddModal" class="btn btn-primary">
                <i class="fas fa-plus"></i> Новая транзакция
            </button>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats-cards">
        <div class="stat-card total-income">
            <div class="stat-icon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@totalIncome.ToString("C")</div>
                <div class="stat-label">Общий доход</div>
            </div>
        </div>

        <div class="stat-card total-expense">
            <div class="stat-icon">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@totalExpense.ToString("C")</div>
                <div class="stat-label">Общие расходы</div>
            </div>
        </div>

        <div class="stat-card balance">
            <div class="stat-icon">
                <i class="fas fa-balance-scale"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@balance.ToString("C")</div>
                <div class="stat-label">Баланс</div>
            </div>
        </div>
    </div>

    <!-- Таблица транзакций -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">📋 История транзакций</h5>
            <div class="btn-group">
                <button class="btn btn-sm @(filter == "all" ? "btn-primary" : "btn-outline-primary")"
                        @onclick='() => SetFilter("all")'>
                    Все
                </button>
                <button class="btn btn-sm @(filter == "income" ? "btn-success" : "btn-outline-success")"
                        @onclick='() => SetFilter("income")'>
                    Доходы
                </button>
                <button class="btn btn-sm @(filter == "expense" ? "btn-danger" : "btn-outline-danger")"
                        @onclick='() => SetFilter("expense")'>
                    Расходы
                </button>
            </div>
        </div>

        <div class="card-body">
            @if (transactions.Count == 0)
            {
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                    <h4>Транзакций пока нет</h4>
                    <p class="text-muted">Добавьте свою первую транзакцию!</p>
                    <button @onclick="ShowAddModal" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Добавить транзакцию
                    </button>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Категория</th>
                                <th>Описание</th>
                                <th class="text-end">Сумма</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var transaction in filteredTransactions)
                            {
                                <tr>
                                    <td>@transaction.Date.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        <span class="badge @(transaction.Category?.IsIncome == true ? "bg-success" : "bg-danger")">
                                            @transaction.Category?.Name
                                        </span>
                                    </td>
                                    <td>@(transaction.Description ?? "-")</td>
                                    <td class="text-end @(transaction.Category?.IsIncome == true ? "text-success" : "text-danger")">
                                        @if (transaction.Category?.IsIncome == true)
                                        {
                                            <i class="fas fa-arrow-up me-1"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-arrow-down me-1"></i>
                                        }
                                        @transaction.Amount.ToString("C")
                                    </td>
                                    <td class="text-center">
                                        <button @onclick='() => EditTransaction(transaction)'
                                                class="btn btn-sm btn-outline-primary me-1">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button @onclick='() => DeleteTransaction(transaction)'
                                                class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Модальное окно добавления/редактирования транзакции -->
@if (showModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(editingTransaction == null ? "Новая транзакция" : "Редактирование")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">Тип</label>
                            <div class="btn-group w-100">
                                <button type="button"
                                        class="btn @(isIncome ? "btn-success" : "btn-outline-success") w-50"
                                        @onclick='() => { isIncome = true; transaction.CategoryId = 0; }'>
                                    <i class="fas fa-arrow-up me-1"></i> Доход
                                </button>
                                <button type="button"
                                        class="btn @(!isIncome ? "btn-danger" : "btn-outline-danger") w-50"
                                        @onclick='() => { isIncome = false; transaction.CategoryId = 0; }'>
                                    <i class="fas fa-arrow-down me-1"></i> Расход
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Категория *</label>
                            <select @bind="transaction.CategoryId" class="form-select" required>
                                <option value="">Выберите категорию</option>
                                @foreach (var category in categories.Where(c => c.IsIncome == isIncome))
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Сумма *</label>
                            <input type="number" step="0.01"
                                   @bind="transaction.Amount"
                                   class="form-control"
                                   placeholder="0.00" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Дата</label>
                            <input type="date"
                                   @bind="transaction.Date"
                                   class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea @bind="transaction.Description"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Описание транзакции..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                        Отмена
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="SaveTransaction" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Transaction> transactions = new();
    private List<Category> categories = new();
    private List<Transaction> filteredTransactions = new();
    private TransactionCreateModel transaction = new();
    private Transaction? editingTransaction;

    private decimal totalIncome = 0;
    private decimal totalExpense = 0;
    private decimal balance = 0;

    private bool showModal = false;
    private bool isSaving = false;
    private bool isIncome = true;
    private string filter = "all";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            // Загружаем транзакции
            transactions = await TransactionService.GetTransactionsAsync();

            // Загружаем категории
            categories = await CategoryService.GetCategoriesAsync();

            // Рассчитываем статистику
            CalculateStatistics();

            // Применяем фильтр
            ApplyFilter();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки данных: {ex.Message}");
        }
    }

    private void CalculateStatistics()
    {
        totalIncome = transactions
            .Where(t => t.Category?.IsIncome == true)
            .Sum(t => t.Amount);

        totalExpense = transactions
            .Where(t => t.Category?.IsIncome == false)
            .Sum(t => t.Amount);

        balance = totalIncome - totalExpense;
    }

    private void ApplyFilter()
    {
        filteredTransactions = filter switch
        {
            "income" => transactions.Where(t => t.Category?.IsIncome == true).ToList(),
            "expense" => transactions.Where(t => t.Category?.IsIncome == false).ToList(),
            _ => transactions
        };
    }

    private void SetFilter(string newFilter)
    {
        filter = newFilter;
        ApplyFilter();
    }

    private void ShowAddModal()
    {
        transaction = new TransactionCreateModel { Date = DateTime.Now };
        editingTransaction = null;
        isIncome = true;
        showModal = true;
    }

    private void EditTransaction(Transaction t)
    {
        editingTransaction = t;
        transaction = new TransactionCreateModel
        {
            Amount = t.Amount,
            Description = t.Description,
            Date = t.Date,
            CategoryId = t.CategoryId
        };
        isIncome = t.Category?.IsIncome == true;
        showModal = true;
    }

    private async Task SaveTransaction()
    {
        if (transaction.CategoryId == 0)
        {
            Console.WriteLine("Выберите категорию!");
            return;
        }

        isSaving = true;

        try
        {
            bool success;

            if (editingTransaction != null)
            {
                // Редактирование существующей транзакции
                var t = new Transaction
                {
                    Id = editingTransaction.Id,
                    Amount = transaction.Amount,
                    Description = transaction.Description,
                    Date = transaction.Date,
                    CategoryId = transaction.CategoryId
                };

                success = await TransactionService.UpdateTransactionAsync(editingTransaction.Id, t);
            }
            else
            {
                // Создание новой транзакции
                success = await TransactionService.CreateTransactionAsync(transaction);
            }

            if (success)
            {
                await LoadData();
                CloseModal();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка сохранения: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteTransaction(Transaction t)
    {
        // Используем IJSRuntime для вызова confirm
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Удалить эту транзакцию?");

        if (confirmed)
        {
            try
            {
                var success = await TransactionService.DeleteTransactionAsync(t.Id);
                if (success)
                {
                    await LoadData();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Ошибка удаления: {ex.Message}");
            }
        }
    }

    private void CloseModal()
    {
        showModal = false;
        transaction = new TransactionCreateModel();
    }
}