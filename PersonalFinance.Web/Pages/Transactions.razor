@page "/transactions"
@attribute [Authorize]
@layout MainLayout
@using PersonalFinance.Web.Models
@using PersonalFinance.Web.Services
@inject TransactionService TransactionService
@inject CategoryService CategoryService
@inject NavigationManager NavigationManager
@inject IJSRuntime jsRuntime

<div class="page-container">
    <div class="page-header">
        <h1>Мои транзакции</h1>
        <button @onclick="ShowAddModal" class="btn btn-primary">
            <i class="fas fa-plus"></i> Добавить
        </button>
    </div>

    <!-- Фильтры -->
    <div class="filters">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Месяц</label>
                    <select @bind="selectedMonth" @bind:after="LoadTransactions" class="form-select">
                    @foreach (var month in months)
                    {
                        <option value="@month.Value">@month.Text</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Категория</label>
                <select @bind="selectedCategoryId" @bind:after="LoadTransactions" class="form-select">
                    <option value="">Все категории</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Тип</label>
                <select @bind="selectedType" @bind:after="LoadTransactions" class="form-select">
                    <option value="">Все</option>
                    <option value="income">Доходы</option>
                    <option value="expense">Расходы</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button @onclick="ExportToCsv" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-download"></i> Экспорт
                </button>
            </div>
        </div>
    </div>

    <!-- Статистика -->
    <div class="stats mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card income">
                    <div class="stat-title">Доходы</div>
                    <div class="stat-value">@totalIncome.ToString("C")</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card expense">
                    <div class="stat-title">Расходы</div>
                    <div class="stat-value">@totalExpense.ToString("C")</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card balance">
                    <div class="stat-title">Баланс</div>
                    <div class="stat-value">@((totalIncome - totalExpense).ToString("C"))</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Таблица транзакций -->
    <div class="table-responsive mt-4">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Дата</th>
                    <th>Категория</th>
                    <th>Описание</th>
                    <th class="text-end">Сумма</th>
                    <th class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </td>
                    </tr>
                }
                else if (!transactions.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            Нет транзакций для отображения
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var transaction in transactions)
                    {
                        <tr>
                            <td>@transaction.Date.ToString("dd.MM.yyyy")</td>
                            <td>
                                <span class="badge @(transaction.Category?.IsIncome == true ? "bg-success" : "bg-danger")">
                                    @transaction.Category?.Name
                                </span>
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(transaction.Description))
                                {
                                    <span class="text-muted">-</span>
                                }
                                else
                                {
                                    @transaction.Description
                                }
                            </td>
                            <td class="text-end @(transaction.Category?.IsIncome == true ? "text-success" : "text-danger")">
                                @if (transaction.Category?.IsIncome == true)
                                {
                                    <i class="fas fa-arrow-up me-1"></i>
                                }
                                else
                                {
                                    <i class="fas fa-arrow-down me-1"></i>
                                }
                                @transaction.Amount.ToString("C")
                            </td>
                            <td class="text-center">
                                <button @onclick="() => EditTransaction(transaction)" 
                                        class="btn btn-sm btn-outline-primary me-1">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @onclick="() => DeleteTransaction(transaction)" 
                                        class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Модальное окно добавления/редактирования -->
@if (showModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(currentTransaction?.Id > 0 ? "Редактирование" : "Новая транзакция")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="@transactionModel" OnValidSubmit="@SaveTransaction">
                        <div class="mb-3">
                            <label class="form-label">Категория *</label>
                            <select @bind="transactionModel.CategoryId" class="form-select" required>
                                <option value="">Выберите категорию</option>
                                @foreach (var category in categories)
                                {
                                    <option value="@category.Id">
                                        @category.Name (@(category.IsIncome ? "Доход" : "Расход"))
                                    </option>
                                }
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Сумма *</label>
                            <input type="number" step="0.01" 
                                   @bind="transactionModel.Amount"
                                   class="form-control" 
                                   placeholder="0.00" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Дата</label>
                            <input type="date"/>
                            <input @bind="transactionModel.Date" />
                                   class="form-control" 
                                   value="@transactionModel.Date.ToString("yyyy-MM-dd")" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Описание</label>
                            <textarea @bind="transactionModel.Description"
                                     class="form-control"
                                     rows="3"
                                     placeholder="Описание..."></textarea>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                                Отмена
                            </button>
                            <button type="submit" class="btn btn-primary" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                Сохранить
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Transaction> transactions = new();
    private List<Category> categories = new();
    private Transaction? currentTransaction;
    private TransactionCreateModel transactionModel = new();
    
    private int selectedMonth = DateTime.Now.Month;
    private int? selectedCategoryId;
    private string? selectedType;
    
    private decimal totalIncome = 0;
    private decimal totalExpense = 0;
    
    private bool isLoading = false;
    private bool isSaving = false;
    private bool showModal = false;
    
    private List<SelectItem> months = new()
    {
        new SelectItem(1, "Январь"), new SelectItem(2, "Февраль"),
        new SelectItem(3, "Март"), new SelectItem(4, "Апрель"),
        new SelectItem(5, "Май"), new SelectItem(6, "Июнь"),
        new SelectItem(7, "Июль"), new SelectItem(8, "Август"),
        new SelectItem(9, "Сентябрь"), new SelectItem(10, "Октябрь"),
        new SelectItem(11, "Ноябрь"), new SelectItem(12, "Декабрь")
    };

    private class SelectItem
    {
        public int Value { get; set; }
        public string Text { get; set; }
        
        public SelectItem(int value, string text)
        {
            Value = value;
            Text = text;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadTransactions();
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = await CategoryService.GetCategoriesAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки категорий: {ex.Message}");
        }
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        try
        {
            // Получаем все транзакции
            transactions = await TransactionService.GetTransactionsAsync();
            
            // Фильтруем по месяцу
            if (selectedMonth > 0)
            {
                transactions = transactions
                    .Where(t => t.Date.Month == selectedMonth && t.Date.Year == DateTime.Now.Year)
                    .ToList();
            }
            
            // Фильтруем по категории
            if (selectedCategoryId.HasValue)
            {
                transactions = transactions
                    .Where(t => t.CategoryId == selectedCategoryId.Value)
                    .ToList();
            }
            
            // Фильтруем по типу
            if (!string.IsNullOrEmpty(selectedType))
            {
                bool isIncome = selectedType == "income";
                transactions = transactions
                    .Where(t => t.Category?.IsIncome == isIncome)
                    .ToList();
            }
            
            // Сортируем по дате
            transactions = transactions
                .OrderByDescending(t => t.Date)
                .ThenByDescending(t => t.Id)
                .ToList();
            
            // Рассчитываем статистику
            CalculateStatistics();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка загрузки транзакций: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CalculateStatistics()
    {
        totalIncome = transactions
            .Where(t => t.Category?.IsIncome == true)
            .Sum(t => t.Amount);
        
        totalExpense = transactions
            .Where(t => t.Category?.IsIncome == false)
            .Sum(t => t.Amount);
    }

    private void ShowAddModal()
    {
        currentTransaction = null;
        transactionModel = new TransactionCreateModel
        {
            Date = DateTime.Now
        };
        showModal = true;
    }

    private void EditTransaction(Transaction transaction)
    {
        currentTransaction = transaction;
        transactionModel = new TransactionCreateModel
        {
            Amount = transaction.Amount,
            Description = transaction.Description,
            Date = transaction.Date,
            CategoryId = transaction.CategoryId
        };
        showModal = true;
    }

    private async Task SaveTransaction()
    {
        isSaving = true;
        try
        {
            bool success;
            
            if (currentTransaction?.Id > 0)
            {
                var transactionToUpdate = new Transaction
                {
                    Id = currentTransaction.Id,
                    Amount = transactionModel.Amount,
                    Description = transactionModel.Description,
                    Date = transactionModel.Date,
                    CategoryId = transactionModel.CategoryId,
                    UserId = currentTransaction.UserId
                };
                
                success = await TransactionService.UpdateTransactionAsync(currentTransaction.Id, transactionToUpdate);
            }
            else
            {
                success = await TransactionService.CreateTransactionAsync(transactionModel);
            }

            if (success)
            {
                await LoadTransactions();
                CloseModal();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка сохранения: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteTransaction(Transaction transaction)
    {
        if (await jsRuntime.InvokeAsync<bool>("confirm", $"Удалить транзакцию от {transaction.Date:dd.MM.yyyy} на сумму {transaction.Amount:C}?"))
        {
            var success = await TransactionService.DeleteTransactionAsync(transaction.Id);
            if (success)
            {
                await LoadTransactions();
            }
        }
    }

    private void CloseModal()
    {
        showModal = false;
        currentTransaction = null;
        transactionModel = new TransactionCreateModel();
    }

    private async Task ExportToCsv()
    {
        var csv = "Дата;Категория;Тип;Сумма;Описание\n";
        
        foreach (var transaction in transactions)
        {
            csv += $"{transaction.Date:dd.MM.yyyy};" +
                   $"{transaction.Category?.Name};" +
                   $"{(transaction.Category?.IsIncome == true ? "Доход" : "Расход")};" +
                   $"{transaction.Amount};" +
                   $"{transaction.Description ?? ""}\n";
        }
        
        var fileName = $"transactions_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        await jsRuntime.InvokeVoidAsync("downloadFile", fileName, "text/csv", csv);
    }
}